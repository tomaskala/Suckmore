#!/bin/sh

render() {
  muted=$(pamixer --get-mute)
  vol_perc=$(pamixer --get-volume)
  bat_charging=$(cat /sys/class/power_supply/BAT0/status)
  bat_perc=$(cat /sys/class/power_supply/BAT0/capacity)
  current_date=$(date +'%a %F')
  current_time=$(date +'%H:%M')
  wg_on=$(ip link | grep -F wg0)

  if pgrep -x mpd > /dev/null; then
    music="$(mpc -f '%artist% - %title%' current)"
  else
    music=""
  fi

  if [ -n "${music}" ]; then
    music="🎵 ${music}"
  fi

  if [ "${muted}" = true ]; then
    vol_status='🔇'
  elif [ "${vol_perc}" -le 30 ]; then
    vol_status='🔈'
  elif [ "${vol_perc}" -le 70 ]; then
    vol_status='🔉'
  else
    vol_status='🔊'
  fi

  if [ "${bat_charging}" = Charging ]; then
    bat_status='⚡'
  elif [ "${bat_charging}" = Discharging ]; then
    bat_status='🔋'
  else
    bat_status='🔌'
  fi

  if [ -n "${wg_on}" ]; then
    wg_status='🔐'
  else
    wg_status='🔓'
  fi

  printf '%s %s %d%% %s %d%% 📅 %s 🕓 %s %s\n' \
    "${music}" \
    "${vol_status}" \
    "${vol_perc}" \
    "${bat_status}" \
    "${bat_perc}" \
    "${current_date}" \
    "${current_time}" \
    "${wg_status}"
}

trap render USR1

while true; do
  render
  sleep 1 &
  wait $!
done
